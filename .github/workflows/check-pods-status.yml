name: Check Pods Status

on:
#  schedule:
#    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  check-pods:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check pods
      uses: appleboy/ssh-action@v1.2.0
      id: check-pods
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        password: ${{ secrets.PASSWD }}
        proxy_host: ${{ secrets.JUMP_HOST }}
        proxy_port: ${{ secrets.JUMP_PORT }}
        proxy_username: ${{ secrets.JUMP_USERNAME }}
        proxy_password: ${{ secrets.JUMP_PASSWD }}
        script: |
            FAILED_PODS=$(kubectl get pods -A | grep -v NAME | grep -v Running | awk '{ print $2 }')
            
            if [ -n "$FAILED_PODS" ]; then
              echo "has_errors=true" >> $GITHUB_OUTPUT
              echo "FAILED_PODS=$FAILED_PODS" >> $GITHUB_OUTPUT
            else
              echo "has_errors=false" >> $GITHUB_OUTPUT
            fi

    - name: Send Slack notification
      if: steps.check-pods.outputs.has_errors == 'true'
      uses: slackapi/slack-github-action@v2.0.0
      with:
        slack-message: 'üö® –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —É–ø–∞–≤—à–∏–µ –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–≤—à–∏–µ—Å—è —Å –æ—à–∏–±–∫–æ–π –ø–æ–¥—ã: ${{ steps.check-pods.outputs.FAILED_PODS }}'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}